<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Control of an RC car</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" href="style.css" media="screen">
<script type="text/javascript" src="/webiopi.js"></script>
<script type="text/javascript">
webiopi().ready(function() {

  // GPIOポートの設定
  var PIN1 = 24; //for servo moter (PWM)
  var PIN2 = 8; //for DC moter (direction of rotation)
  var PIN3 = 10; //for DC moter (direction of rotation)
  var PIN4 = 12; //for DC moter (PWM)

  // その他設定
  var DCMOTOR_DUTY = 0;
  var SVMOTOR_DUTY = 8.4;
	    
  // 関数：方向を変える
  function change_direction(mode) {
    if(mode == "FOWARD") {    // 前進
      dcmotor(0);
    } else if(mode == "BACKWARD") {    // 後退
      dcmotor(1);
    } else if(mode == "RIGHT") {    // 右旋回
      servomotor(PIN1, 1, 0.25);
    } else if(mode == "LEFT") {    // 左旋回
      servomotor(PIN1, 0, 0.25);
    } 
  }

  // 関数：前進か後退のために、DCを制御
  function dcmotor(value) {
    if(value == 0){
      //前進				    
      webiopi().callMacro( 'output_control', [PIN2,1] );
      webiopi().callMacro( 'output_control', [PIN3,0] );
    }else{
      //後退				    
      webiopi().callMacro( 'output_control', [PIN2,0] );
      webiopi().callMacro( 'output_control', [PIN3,1] );			    }				    
  }
				    
  // 関数：左折か右折のために、servoを制御
  function servomotor(pin, left, value) {
    if(left == 1){
      //左折				    
      SVMOTOR_DUTY = SVMOTOR_DUTY - value;
      if(SVMOTOR_DUTY < 5.4){				    
        webiopi().callMacro( 'servo_duty', 5.4 );
	SVMOTOR_DUTY = 5.4		
      }else{
	webiopi().callMacro( 'servo_duty', SVMOTOR_DUTY );
      }
    }else{
      //右折
      SVMOTOR_DUTY = SVMOTOR_DUTY + value;
      if(SVMOTOR_DUTY > 11.4){
        webiopi().callMacro( 'servo_duty', 11.4 );
        SVMOTOR_DUTY = 11.4
      }else{				    
        webiopi().callMacro( 'servo_duty', SVMOTOR_DUTY );
      }
    }
  }	
				    
  // 関数：スピードの変更
  function change_speed(mode) {
    if(mode == "UP") {
      //加速				    
      dcmotor_speed(10);
    } else if(mode == "DOWN") {
      //減速
      dcmotor_speed(-10);
    } else if(mode == "STOP") {
      //停止				    
      dcmotor_speed(0);
    }				    
  }

  // 関数：加減速のために、DCを制御
  function dcmotor_speed(value) {
    if(value == 0){
      DCMOTOR_DUTY = value;
      webiopi().callMacro( 'dc_duty', value );    
    }else{
       DCMOTOR_DUTY = DCMOTOR_DUTY + value;
       if(DCMOTOR_DUTY > 100){
         DCMOTOR_DUTY = 100;
       }else if(DCMOTOR_DUTY < 0){
	 DCMOTOR_DUTY = 0;
       }
       webiopi().callMacro( 'dc_duty', DCMOTOR_DUTY ); 			
    }
  }
			      			       

  // 「前進」ボタンが押されたときのイベント処理
  $('#forward').click(function(event) {
    change_direction('FOWARD');
  });

  // 「後退」ボタンが押されたときのイベント処理
  $('#backward').click(function(event) {
    change_direction('BACKWARD');
  });

  // 「右」ボタンが押されたときのイベント処理
  $('#right').click(function(event) {
    change_direction('RIGHT');
  });

  // 「左」ボタンが押されたときのイベント処理
  $('#left').click(function(event) {                        
    change_direction('LEFT');
  });

  // 「加速」ボタンが押されたときのイベント処理
  $('#speedup').click(function(event) {
    change_speed('UP');
  });

  // 「減速」ボタンが押されたときのイベント処理
  $('#speeddown').click(function(event) {
    change_speed('DOWN');
  });

  // 「停止」ボタンが押されたときのイベント処理
  $('#stop').click(function(event) {
    change_speed('STOP');
  });

  // メイン
  //servomotor(PIN1, 1, 3);
  //webiopi().callMacro( 'sleep');
  //servomotor(PIN1, 0, 3);
  //webiopi().callMacro( 'sleep');			     
  //dcmotor(0);
  //webiopi().callMacro( 'sleep');
  //change_speed('UP');
  //webiopi().callMacro( 'sleep');			    
});
</script>
</head>
<body>
<div id="wrapper">

<header>
  <div class="header">
    ラジコンカーを走らせる
  </div>
</header>

<nav>
  <div class="nav-zero">
    <ul>
      <li class="wakunone"></li>
      <li id="forward" class="ledoff"><br/>前進<br/></li>
      <li class="wakunone"></li>
      <li id="speedup" class="ledoff"><br/>加速<br/></li>
    </ul>
    <ul>
      <li id="left" class="ledoff"><br/>左<br/></li>
      <li class="wakunone"></li>
      <li id="right" class="ledoff"><br/>右<br/></li>
      <li class="wakunone"></li>      
    </ul>
    <ul>
      <li class="wakunone"></li>
      <li id="backward" class="ledoff"><br/>後退<br/></li>
      <li class="wakunone"></li>
      <li id="speeddown" class="ledoff"><br/>減速<br/></li>
    </ul>
    <ul>
      <li class="wakunone"></li>
      <li class="wakunone"></li>
      <li id="stop" class="ledoff"><br/>停止<br/></li>
      <li class="wakunone"></li>      
    </ul>
  </div>
  <div class="clear"></div>
</nav>

</div>
</body>
</html>
